name: Build AMI + Manage Full Private Infra

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select Environment"
        required: true
        type: choice
        options:
          - dev
          - prod
      action:
        description: "Select action"
        required: true
        type: choice
        options:
          - apply
          - destroy

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    env:
      ENV: ${{ github.event.inputs.environment }}
      ACTION: ${{ github.event.inputs.action }}
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v4

      #############################################
      # AWS OIDC LOGIN
      #############################################
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::091756093438:role/github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Test AWS Identity
        run: aws sts get-caller-identity

      #############################################
      # BUILD AMI ONLY IF ACTION=apply
      #############################################
      - name: Check Existing AMI
        if: ${{ env.ACTION == 'apply' }}
        id: check_ami
        run: |
          AMI_ID=$(aws ec2 describe-images \
            --owners self \
            --filters "Name=tag:Name,Values=java21-${ENV}" \
            --query 'Images | sort_by(@,&CreationDate)[-1].ImageId' \
            --output text)

          if [ "$AMI_ID" != "None" ] && [ "$AMI_ID" != "" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
            echo "Found AMI: $AMI_ID"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No AMI found"
          fi

      - name: Setup Packer
        if: ${{ env.ACTION == 'apply' && steps.check_ami.outputs.exists == 'false' }}
        uses: hashicorp/setup-packer@v3

      - name: Packer Init
        if: ${{ env.ACTION == 'apply' && steps.check_ami.outputs.exists == 'false' }}
        working-directory: .github/packer
        run: packer init java21-ami.pkr.hcl

      - name: Packer Build
        if: ${{ env.ACTION == 'apply' && steps.check_ami.outputs.exists == 'false' }}
        working-directory: .github/packer
        run: |
          packer build \
            -var "env=${ENV}" \
            java21-ami.pkr.hcl

      - name: Set AMI ID
        if: ${{ env.ACTION == 'apply' }}
        run: |
          if [ "${{ steps.check_ami.outputs.exists }}" == "true" ]; then
            echo "AMI_ID=${{ steps.check_ami.outputs.ami_id }}" >> $GITHUB_ENV
          else
            AMI_ID=$(jq -r '.builds[-1].artifact_id' manifest.json | cut -d':' -f2)
            echo "AMI_ID=$AMI_ID" >> $GITHUB_ENV
          fi

      #############################################
      # TERRAFORM INIT
      #############################################
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -backend-config="key=${ENV}/terraform.tfstate"

      #############################################
      # TERRAFORM APPLY OR DESTROY
      #############################################
      - name: Terraform Apply/Destroy
        working-directory: terraform
        run: |
          if [ "${ACTION}" == "apply" ]; then
            terraform apply -auto-approve \
              -var="env=${ENV}" \
              -var="microservice_ami=${AMI_ID}" \
              -var="nginx_ami=ami-xxxxxxxx" \
              -var="db_username=admin" \
              -var="db_password=YourStrongPassword123!"
          else
            terraform destroy -auto-approve \
              -var="env=${ENV}" \
              -var="microservice_ami=${AMI_ID}" \
              -var="nginx_ami=ami-xxxxxxxx" \
              -var="db_username=admin" \
              -var="db_password=YourStrongPassword123!"