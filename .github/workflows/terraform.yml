name: Build AMI + Deploy Full Private Infra

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      #############################################
      # AWS OIDC LOGIN
      #############################################
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::091756093438:role/github-oidc-role
          aws-region: us-east-1

          
      #############################################
      # CHECK IF AMI EXISTS
      #############################################
      - name: Check Existing AMI
        id: check_ami
        run: |
          AMI_ID=$(aws ec2 describe-images \
            --owners self \
            --filters "Name=tag:Name,Values=java21-golden" \
            --query 'Images | sort_by(@,&CreationDate)[-1].ImageId' \
            --output text)

          if [ "$AMI_ID" != "None" ] && [ "$AMI_ID" != "" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
            echo "Found AMI: $AMI_ID"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No AMI found"
          fi

      #############################################
      # BUILD AMI ONLY IF NOT EXISTS
      #############################################
      - name: Setup Packer
        if: steps.check_ami.outputs.exists == 'false'
        uses: hashicorp/setup-packer@v3

      - name: Packer Init
        if: steps.check_ami.outputs.exists == 'false'
        run: packer init packer/java21-ami.pkr.hcl

      - name: Packer Build
        if: steps.check_ami.outputs.exists == 'false'
        run: packer build packer/java21-ami.pkr.hcl
        
      - name: Set AMI ID
        run: |
          if [ "${{ steps.check_ami.outputs.exists }}" == "true" ]; then
            echo "AMI_ID=${{ steps.check_ami.outputs.ami_id }}" >> $GITHUB_ENV
          else
            AMI_ID=$(jq -r '.builds[-1].artifact_id' manifest.json | cut -d':' -f2)
            echo "AMI_ID=$AMI_ID" >> $GITHUB_ENV
          fi

      #############################################
      # TERRAFORM DEPLOY
      #############################################
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: |
          terraform apply -auto-approve \
            -var="microservice_ami=${{ env.AMI_ID }}" \
            -var="nginx_ami=ami-xxxxxxxx" \
            -var="db_username=admin" \
            -var="db_password=YourStrongPassword123!"