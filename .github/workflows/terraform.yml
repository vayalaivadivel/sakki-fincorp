name: Infra creation

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose action"
        required: true
        type: choice
        options:
          - apply
          - destroy
      deploy_confirmation:
        description: 'Type yes to confirm deployment'
        required: true
        default: 'no'

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      # 3Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 4Ô∏è‚É£ Safety check for deploy_confirmation
      - name: Confirm Deployment
        run: |
          if [ "${{ github.event.inputs.deploy_confirmation }}" != "yes" ]; then
            echo "deploy_confirmation is not 'yes'. Exiting."
            exit 1
          fi

      # 5Ô∏è‚É£ Ensure S3 backend bucket exists and DynamoDB table (auto-create)
      - name: Ensure Backend Resources
        run: |
          BUCKET_NAME=$(grep 'bucket' terraform/infra/backend.tf | awk -F\" '{print $2}')
          DDB_TABLE_NAME=$(grep 'dynamodb_table' terraform/infra/backend.tf | awk -F\" '{print $2}')

          # Create S3 bucket if missing
          if ! aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "S3 bucket '$BUCKET_NAME' missing. Creating..."
            aws s3api create-bucket \
              --bucket "$BUCKET_NAME" \
              --region ${{ secrets.AWS_REGION }} \
              --create-bucket-configuration LocationConstraint=${{ secrets.AWS_REGION }}
          fi
          echo "Waiting for S3 bucket to exist..."
          aws s3api wait bucket-exists --bucket "$BUCKET_NAME"

          # Create DynamoDB table if missing
          if [ ! -z "$DDB_TABLE_NAME" ]; then
            if ! aws dynamodb describe-table --table-name "$DDB_TABLE_NAME" >/dev/null 2>&1; then
              echo "Creating DynamoDB table '$DDB_TABLE_NAME'..."
              aws dynamodb create-table \
                --table-name "$DDB_TABLE_NAME" \
                --attribute-definitions AttributeName=LockID,AttributeType=S \
                --key-schema AttributeName=LockID,KeyType=HASH \
                --billing-mode PAY_PER_REQUEST
            fi
            echo "Waiting for DynamoDB table '$DDB_TABLE_NAME' to be active..."
            aws dynamodb wait table-exists --table-name "$DDB_TABLE_NAME"
          fi

      # 6Ô∏è‚É£ Log backend status
      - name: Log Backend Status
        run: |
          BUCKET_NAME=$(grep 'bucket' terraform/infra/backend.tf | awk -F\" '{print $2}')
          DDB_TABLE_NAME=$(grep 'dynamodb_table' terraform/infra/backend.tf | awk -F\" '{print $2}')

          echo "‚úÖ S3 Backend Bucket Status:"
          aws s3api head-bucket --bucket "$BUCKET_NAME" && echo "Bucket exists and ready."

          if [ ! -z "$DDB_TABLE_NAME" ]; then
            echo "‚úÖ DynamoDB Table Status:"
            aws dynamodb describe-table --table-name "$DDB_TABLE_NAME" | jq '{TableName: .Table.TableName, TableStatus: .Table.TableStatus}'
          fi

      # 7Ô∏è‚É£ Terraform Init
      - name: Terraform Init
        run: terraform -chdir=terraform/infra init -reconfigure

      # 8Ô∏è‚É£ Terraform Plan
      - name: Terraform Plan
        run: terraform -chdir=terraform/infra plan -out=tfplan

      # 9Ô∏è‚É£ Terraform Apply
      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        run: terraform -chdir=terraform/infra apply -auto-approve tfplan

      # üîü Terraform Destroy
      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: terraform -chdir=terraform/infra destroy -auto-approve

      # 1Ô∏è‚É£1Ô∏è‚É£ List state (verification)
      - name: Terraform State List
        run: terraform -chdir=terraform/infra state list

      # 1Ô∏è‚É£2Ô∏è‚É£ Summary: Count resources
      - name: Terraform Resource Summary
        run: |
          COUNT=$(terraform state list | wc -l)
          echo "‚úÖ Total resources managed by Terraform: $COUNT"